전체 인증 흐름 요약 (우리가 만든 현재 구조)
1) 일반 회원가입(이메일+비밀번호)

/signup

입력: name, email, password, password_confirm (+선택정보)

DB: users에 레코드 생성

is_verified=False

verify_token/verify_code와 만료시간 저장

/email/request-verify

입력: email

동작: 새 verify_token/verify_code 발급, (메일 설정돼 있으면) 메일 발송

테스트 페이지(/play)에서는 dev용 토큰/코드도 응답에서 같이 보여줌

/email/verify 또는 /email/verify/code

입력: 토큰(또는 6자리 코드)

DB: is_verified=True, 토큰/코드 및 만료 삭제

/login

입력: email, password

조건: is_verified=True 여야 성공

성공 시 JWT access_token 반환

/me

헤더 Authorization: Bearer <token>으로 호출 → 내 프로필 조회

상태 변화: is_verified: False → True
실패 포인트: 토큰/코드 만료, 중복 이메일, 약한 비밀번호 등

2) 구글 로그인(OAuth)

/auth/google/login

구글 로그인/동의 페이지로 리다이렉트

(이미 로그인·동의된 세션이면 자동 통과할 수 있음 → 필요 시 prompt="select_account" 등으로 강제 노출)

/auth/google/callback

구글에서 code를 주면 사용자 정보(email, sub 등) 가져옴

DB: 같은 email의 유저가 없으면 생성

provider="google", is_verified=True, profile_completed=False

JWT 발급 후 /play로 리다이렉트(#access_token=...&next=...)

/play → /me

해시에 온 access_token을 저장 → 버튼으로 /me 호출해 상태 확인

profile_completed=False이면

/profile/complete

입력: address, phone, gender, mbti, birthdate(선택)

DB: 해당 필드 업데이트, profile_completed=True

상태 변화: is_verified=True(바로) / profile_completed: False → True
프론트가 있으면 콜백 목적지를 프론트 라우트로 바꾸면 됨.

3) 비밀번호 재설정(로컬 계정만)

/password/request

입력: email → reset_token 발급(+만료). (메일 설정돼 있으면 발송)

/play에서는 dev용 reset_token을 응답으로도 보여줌

/password/reset

입력: token, new_password, new_password_confirm

DB: 비밀번호 해시 교체, reset_token 삭제

4) 데이터 흐름(핵심 컬럼)

email : 아이디 겸 로그인 식별자(로컬/구글 공통)

password_hash : 로컬 계정만 사용(구글은 dummy)

is_verified : 이메일 인증 여부(로컬), 구글은 True로 저장

verify_token / verify_code / *_exp : 이메일 인증용(임시)

reset_token / reset_token_exp : 비밀번호 재설정용(임시)

provider : "local" 또는 "google"

profile_completed : 추가정보 입력 완료 여부(구글 온보딩에서 사용)

5) 테스트 방법(로컬)

서버 실행: uvicorn main:app --reload

테스트 페이지: http://127.0.0.1:8000/play

회원가입 → 인증(토큰/코드) → 로그인 → /me

구글 로그인 → /play로 돌아오면 토큰 자동 저장 → /me

추가입력 저장 → /me로 profile_completed: true 확인

비번 재설정: request → reset

6) 설정 요약

DB(.env)
DATABASE_URL=postgresql+psycopg2://myproject_user:비번@localhost:5432/myproject_db

메일(.env, 선택)
MAIL_SERVER, MAIL_PORT, MAIL_STARTTLS, MAIL_SSL_TLS, MAIL_USERNAME, MAIL_PASSWORD, MAIL_FROM
(없으면 메일은 건너뛰고 dev용 토큰/코드만 응답)

구글 OAuth(.env)
GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, API_ORIGIN=http://127.0.0.1:8000

Google Console에 Redirect URI:
http://127.0.0.1:8000/auth/google/callback (또는 사용 포트로 일치시킴)